<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fridge Detector (Camera)</title>
</head>
<body>
  <h1>Fridge Detector (Camera)</h1>

  <video id="video" autoplay playsinline style="width: 320px; background: #000;"></video>
  <div>
    Status: <span id="statusText">Loading...</span><br>
    Current opening: <span id="stopwatch">00:00:00</span>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- ^ using compat version for simplicity in this demo -->

  <script>
    // TODO: REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      databaseURL: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // HTML elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('statusText');
    const stopwatchSpan = document.getElementById('stopwatch');

    // State
    let isCurrentlyOpen = false;
    let openStartTime = 0;
    let stopwatchInterval = null;

    // Start camera
    navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' }, 
      audio: false 
    }).then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        // set canvas size
        canvas.width = 320;
        canvas.height = 240;
        requestAnimationFrame(analyzeFrame);
      };
    }).catch(err => {
      console.error("Camera error:", err);
      statusText.textContent = "Could not access camera.";
    });

    function analyzeFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = frame.data;
        const len = data.length;
        let total = 0;
        for (let i = 0; i < len; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          // Simple luminance
          const lum = 0.299*r + 0.587*g + 0.114*b;
          total += lum;
        }
        const avg = total / (canvas.width * canvas.height);

        // threshold
        const threshold = 80;
        const isOpen = avg > threshold;

        if (isOpen && !isCurrentlyOpen) {
          // closed -> open
          isCurrentlyOpen = true;
          openStartTime = Date.now();
          startStopwatch();
          setStatusInFirebase(true);
        } else if (!isOpen && isCurrentlyOpen) {
          // open -> closed
          isCurrentlyOpen = false;
          stopStopwatch();
          setStatusInFirebase(false);
        }

        statusText.textContent = isOpen ? "Open" : "Closed";
      }
      requestAnimationFrame(analyzeFrame);
    }

    function startStopwatch() {
      if (stopwatchInterval) return;
      stopwatchInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = now - openStartTime;
        stopwatchSpan.textContent = formatTime(elapsed);
      }, 500);
    }

    function stopStopwatch() {
      if (stopwatchInterval) {
        clearInterval(stopwatchInterval);
        stopwatchInterval = null;
      }
      const endTime = Date.now();
      const elapsed = endTime - openStartTime;
      // Log to Firebase
      addLogEntryToFirebase(openStartTime, endTime, elapsed);
      stopwatchSpan.textContent = "00:00:00";
    }

    function setStatusInFirebase(isOpen) {
      // Write the current open/closed status
      firebase.database().ref('fridge/currentStatus').set({
        isOpen: isOpen,
        timestamp: Date.now()
      });
    }

    function addLogEntryToFirebase(start, end, durationMs) {
      const logsRef = db.ref('fridge/logs');
      logsRef.push({
        start,
        end,
        durationMs
      });
    }

    function formatTime(ms) {
      let s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      s %= 3600;
      const m = Math.floor(s / 60);
      s = s % 60;
      return [h, m, s].map(x => String(x).padStart(2,'0')).join(':');
    }
  </script>
</body>
</html>
