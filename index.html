<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Køleskabsdetektor m. PDF-log</title>
  <link rel="stylesheet" href="styles.css">

  <!-- jsPDF via CDN -->
  <script 
    src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
    integrity="sha256-rxzf+uZ6SOWTzSe0zqSz9Q9Fm6GHPQLr6vmz2fa2bW4="
    crossorigin="anonymous"
  ></script>
</head>
<body>
  <div class="main-container">
    <div class="camera-log-container">

      <!-- Venstre boks: Kamera og status -->
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="status-overlay">
          <span id="status">Afventer køleskabsstatus...</span>
        </div>
      </div>

      <!-- Højre boks: “Nuværende åbning”, log og længste periode -->
      <div class="info-container">
        
        <div class="stopwatch-box">
          <p class="stopwatch-title">Nuværende åbning:</p>
          <p id="stopwatch" class="stopwatch-time">00:00:00</p>
        </div>
        
        <div class="longest-period-box">
          <p class="longest-period-title">Længste åbning:</p>
          <p id="longestPeriod" class="longest-period-time">00:00:00</p>
          <p id="longestPeriodTime" class="longest-period-stamp">Ingen data endnu</p>
        </div>

        <div class="log-container">
          <h2>Historik</h2>
          <div id="log"></div>
          <!-- Ny knap til at downloade PDF -->
          <button id="downloadPdfBtn">Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Skjult canvas til billedanalyse -->
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- Audio til alarm-tone (loop). Udskift evt. kilden med egne lydfiler -->
  <audio id="alarmAudio" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>

  <script>
    // HTML-elementer
    const video = document.getElementById('video');
    const statusSpan = document.getElementById('status');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    const stopwatchSpan = document.getElementById('stopwatch');
    const logDiv = document.getElementById('log');

    const longestPeriodSpan = document.getElementById('longestPeriod');
    const longestPeriodTimeSpan = document.getElementById('longestPeriodTime');

    // Alarm
    const alarmAudio = document.getElementById('alarmAudio');

    // Tilstands-variabler
    let isCurrentlyOpen = false;      // true = åbent, false = lukket
    let openStartTime = 0;           // hvornår køleskabet blev åbnet (ms)
    let stopwatchInterval = null;    // ID til setInterval for "Nuværende åbning"
    
    // Alarm-grænse (i ms). 30 sek = 30000 ms
    const ALARM_THRESHOLD_MS = 30000;
    let alarmIsPlaying = false;

    // Længste periode: gemmer varighed + start/slut
    let longestDurationMs = 0;
    let longestDurationStart = 0;
    let longestDurationEnd = 0;

    // Start kamera (bagkamera)
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' },
      audio: false
    })
    .then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        // Størrelse for tegning på canvas
        canvas.width = 480;
        canvas.height = 360;
        // Start løbende billedanalyse
        requestAnimationFrame(analyzeFrame);
      };
    })
    .catch(err => {
      console.error("Kamera-fejl:", err);
      statusSpan.textContent = "Kunne ikke få adgang til kameraet.";
    });

    // Løbende billedanalyse: afgør Åben vs. Lukket
    function analyzeFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = frame.data;
        const length = data.length; // 4 bytes pr pixel: RGBA

        let totalLuminance = 0;
        for (let i = 0; i < length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const lum = 0.299*r + 0.587*g + 0.114*b;
          totalLuminance += lum;
        }

        const numPixels = canvas.width * canvas.height;
        const avgLuminance = totalLuminance / numPixels;

        // Threshold for åben vs. lukket
        const threshold = 80;  // Justér "følsomhed"
        const isOpen = avgLuminance > threshold;

        // Skift fra lukket -> åbent
        if (isOpen && !isCurrentlyOpen) {
          isCurrentlyOpen = true;
          openStartTime = Date.now();
          startStopwatch();
        }
        // Skift fra åbent -> lukket
        else if (!isOpen && isCurrentlyOpen) {
          isCurrentlyOpen = false;
          stopStopwatch();
        }

        // Opdater status
        statusSpan.textContent = isOpen ? "Åbent" : "Lukket";
      }
      requestAnimationFrame(analyzeFrame);
    }

    // Starter "Nuværende åbning"-timer
    function startStopwatch() {
      if (stopwatchInterval) return; // kører allerede?

      stopwatchInterval = setInterval(() => {
        const now = Date.now();
        const elapsedMs = now - openStartTime;
        stopwatchSpan.textContent = formatTime(elapsedMs);

        // Tjek om alarm skal startes
        if (elapsedMs >= ALARM_THRESHOLD_MS && !alarmIsPlaying) {
          startAlarm();
        }
      }, 500);
    }

    // Stopper "Nuværende åbning" og logger
    function stopStopwatch() {
      // Stop interval
      if (stopwatchInterval) {
        clearInterval(stopwatchInterval);
        stopwatchInterval = null;
      }
      // Stop alarm, hvis den spiller
      stopAlarm();

      const endTime = Date.now();
      const elapsedMs = endTime - openStartTime;

      // Tjek om det er ny "længste åbning"
      if (elapsedMs > longestDurationMs) {
        longestDurationMs = elapsedMs;
        longestDurationStart = openStartTime;
        longestDurationEnd = endTime;

        // Opdater felt for længste åbning
        longestPeriodSpan.textContent = formatTime(longestDurationMs);
        const startStr = formatClockTime(new Date(longestDurationStart));
        const endStr = formatClockTime(new Date(longestDurationEnd));
        longestPeriodTimeSpan.textContent = `Klokken ${startStr} - ${endStr}`;
      }

      // Tilføj log-linje
      const startDate = new Date(openStartTime);
      const endDate = new Date(endTime);
      const startStr = formatClockTime(startDate);
      const endStr = formatClockTime(endDate);
      const durationStr = formatTime(elapsedMs);

      const logEntry = document.createElement('div');
      logEntry.innerText = `Klokken ${startStr} - ${endStr}\nÅben i ${durationStr}`;
      logDiv.prepend(logEntry);

      // Nulstil "Nuværende åbning"
      stopwatchSpan.textContent = "00:00:00";
    }

    // Alarm-funktioner
    function startAlarm() {
      alarmIsPlaying = true;
      try {
        alarmAudio.play().catch(err => {
          console.warn("Kunne ikke afspille alarm:", err);
        });
      } catch (error) {
        console.warn("Alarm-fejl:", error);
      }
    }

    function stopAlarm() {
      alarmIsPlaying = false;
      if (!alarmAudio.paused) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0; // Spol tilbage til start
      }
    }

    // Hjælpefunktion: ms -> “HH:MM:SS”
    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        seconds.toString().padStart(2, '0')
      ].join(':');
    }

    // Hjælpefunktion: Date -> “HH:MM:SS”
    function formatClockTime(dateObj) {
      const hours = String(dateObj.getHours()).padStart(2, '0');
      const mins = String(dateObj.getMinutes()).padStart(2, '0');
      const secs = String(dateObj.getSeconds()).padStart(2, '0');
      return `${hours}:${mins}:${secs}`;
    }

    // --- PDF-funktionalitet med jsPDF ---
    document.addEventListener('DOMContentLoaded', () => {
      const downloadBtn = document.getElementById('downloadPdfBtn');
      downloadBtn.addEventListener('click', () => {
        // Hent alle <div> i loggen
        const logEntries = document.querySelectorAll('#log > div');
        
        let combinedText = '';
        logEntries.forEach(entry => {
          combinedText += entry.innerText + '\n\n';
        });
        
        // Opret jsPDF-dokument
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tilføj teksten i PDF (10,10 = x,y)
        doc.text(combinedText, 10, 10);

        // Download filen
        doc.save('log.pdf');
      });
    });
  </script>
</body>
</html>
